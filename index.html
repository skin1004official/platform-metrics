<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì œí’ˆ ìˆœìœ„ íŠ¸ë Œë“œ ëŒ€ì‹œë³´ë“œ</title>



  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <!-- Litepicker ìŠ¤íƒ€ì¼ ë° ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
  <style>
    /* ë¡œê·¸ì¸ ì „ í™”ë©´ ìˆ¨ê¹€ */
    #dashboard-content { display: none; }
    #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
    .login-btn { padding: 12px 24px; font-size: 16px; background-color: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .logout-btn { position: absolute; top: 16px; right: 16px; padding: 8px 16px; background-color: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; }

    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background-color: #f8f9fa;
    }
    h1 {
      font-size: 24px;
      color: #333;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    select, button {
      padding: 8px;
      font-size: 14px;
    }
    #chart_div {
      width: 100%;
      height: 900px;
      margin-top: 40px;
    }

    #fullscreen-loader {
      display: none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .loading-text {
      font-size: 16px;
      color: #333;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .custom-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: background-color 0.2s ease;
      color: white;
    }

    .custom-btn.blue {
      background-color: #3b82f6;
    }

    .custom-btn.blue:hover {
      background-color: #2563eb;
    }

    .custom-btn.green {
      background-color: #10b981;
    }

    .custom-btn.green:hover {
      background-color: #059669;
    }

    .custom-btn.olivedrab {
      background-color: #6b8e23;
    }

    .custom-btn.olivedrab:hover {
      background-color: #4c6619;
    }

    label {
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
      color: #333;
    }

    .styled-input,
    .styled-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .styled-select {
      height: 120px;
    }

    .styled-input:focus,
    .styled-select:focus {
      border-color: #4f46e5;
      outline: none;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    .brand-filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 20px 0;
      align-items: center;
    }

    .brand-filter-container button {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      line-height: 1.4;
      white-space: nowrap;
    }

  </style>
</head>
<body>
  <!-- âœ… ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="login-screen">
    <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
    <button class="login-btn" onclick="signInWithGoogle()">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
  </div>

  <!-- âœ… ì‹¤ì œ ì½˜í…ì¸ ëŠ” ë¡œê·¸ì¸ í›„ ë³´ì—¬ì§ -->
  <div id="dashboard-content">
    <div id="fullscreen-loader">
      <div class="spinner"></div>
      <div class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <h1>ì œí’ˆ ìˆœìœ„ íŠ¸ë Œë“œ ëŒ€ì‹œë³´ë“œ</h1>

    <div class="filters">
      <!-- ì²« ë²ˆì§¸ ì¤„: í•„í„° + ì œí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
      <div style="grid-column: span 7; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, auto)); gap: 30px;">
        <div>
          <label for="dateRange">ë‚ ì§œ ë²”ìœ„</label>
          <input type="text" id="dateRange" placeholder="ë‚ ì§œ ì„ íƒ..."  class="styled-select" style="height: 20px;" />
        </div>
        <div>
          <label for="channelFilter">í”Œë«í¼</label>
          <select id="channelFilter" multiple class="styled-select"></select>
        </div>
        <div>
          <label for="catBFilter">ì¹´í…Œê³ ë¦¬(ëŒ€)</label>
          <select id="catBFilter" multiple class="styled-select"></select>
        </div>
        <div>
          <label for="catMFilter">ì¹´í…Œê³ ë¦¬(ì¤‘)</label>
          <select id="catMFilter" multiple class="styled-select"></select>
        </div>
        <div>
          <label for="catSFilter">ì¹´í…Œê³ ë¦¬(ì†Œ)</label>
          <select id="catSFilter" multiple class="styled-select"></select>
        </div>
        <div>
          <label for="brandFilter">ë¸Œëœë“œ</label>
          <select id="brandFilter" multiple class="styled-select"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button onclick="loadChartBrand()" class="custom-btn blue">ì°¨íŠ¸ ê·¸ë¦¬ê¸°(ë¸Œëœë“œ ì ìˆ˜)</button>

        </div>
      </div>

      <!-- ë‘ ë²ˆì§¸ ì¤„: ì œí’ˆ ì„ íƒ + ì°¨íŠ¸ ê·¸ë¦¬ê¸° ë²„íŠ¼ -->
      <div style="grid-column: span 6; display: flex; gap: 20px; margin-top: 25px;">
        <div style="flex: 1;">
          <label for="productFilter">ì œí’ˆ</label>
          <select id="productFilter" multiple size="4"  class="styled-select" style="width: 100%;"></select>
        </div>
        <div style="display: flex; align-items: flex-end;">
          <button onclick="loadProductOptions()" class="custom-btn olivedrab">ì œí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div style="display: flex; align-items: flex-end;">
          <button onclick="loadChart()" class="custom-btn green">ì°¨íŠ¸ ê·¸ë¦¬ê¸°(ì œí’ˆ ìˆœìœ„)</button>
        </div>
      </div>
    </div>


    <div id="brandHighlightButtons" class="brand-filter-container" style="padding-top: 30px"></div>


    <!-- <div id="chart_div">ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div> -->
    <div id="multi_chart_container" style="padding-top: 30px">ì°¨íŠ¸ ì˜ì—­</div>
  </div>

  <!-- âœ… Firebase SDK ì¶”ê°€ -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>

  <script>
    window.onload = () => {
      const firebaseConfig = {
        apiKey: "AIzaSyBrKxLpD99V6Nq8W3UtQAiS3uPCnDmNfls",
        authDomain: "platform-metrics-131f0.firebaseapp.com",
        projectId: "platform-metrics-131f0"
      };
      firebase.initializeApp(firebaseConfig);

      const auth = firebase.auth();
      const ALLOWED_DOMAINS = ["skin1004korea.com", "cravercorp.com"];

      auth.onAuthStateChanged(user => {
        if (user) {
          const email = user.email || "";
          const domain = email.split("@")[1];
          if (ALLOWED_DOMAINS.includes(domain)) {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("dashboard-content").style.display = "block";
          } else {
            alert("í—ˆìš©ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤: " + domain);
            auth.signOut();
          }
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("dashboard-content").style.display = "none";
        }
      });

      window.signInWithGoogle = () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
          alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
        });
      };

      window.logout = () => {
        auth.signOut().then(() => {
          location.reload();
        });
      };
    };
  </script>

  <script>
    let startDate = "";
    let endDate = "";

    const picker = new Litepicker({
      element: document.getElementById("dateRange"),
      singleMode: false,
      format: "YYYY-MM-DD",
      setup: (picker) => {
        picker.on('selected', (start, end) => {
          startDate = start.format("YYYY-MM-DD");
          endDate = end.format("YYYY-MM-DD");
          console.log("ì„ íƒëœ ë‚ ì§œ ë²”ìœ„:", startDate, endDate);
        });
      }
    });


    const FILTER_API = "https://asia-northeast3-skin1004-319714.cloudfunctions.net/get_filter_options";
    const DATA_API = "https://asia-northeast3-skin1004-319714.cloudfunctions.net/get_chart_data";
    const DATA_BRAND_API = "https://asia-northeast3-skin1004-319714.cloudfunctions.net/get_brand_score_chart_data";
    let fullFilterData = {};

    function getSelectValues(id) {
      return Array.from(document.getElementById(id).selectedOptions).map(opt => opt.value);
    }

    function populateSelect(id, options) {
      const selectEl = document.getElementById(id);

      // âœ… ê¸°ì¡´ ì„ íƒ ê°’ ì €ì¥
      const selectedValues = Array.from(selectEl.selectedOptions).map(opt => opt.value);

      // âŒ ê¸°ì¡´ TomSelect ì¸ìŠ¤í„´ìŠ¤ ì œê±°
      if (selectEl.tomselect) {
        selectEl.tomselect.destroy();
      }

      // ğŸ”„ ì˜µì…˜ ì¬êµ¬ì„±
      selectEl.innerHTML = "";
      options.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        selectEl.appendChild(opt);
      });

      // âœ… TomSelect ì¬ìƒì„± (âŒ items ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
      const tom = new TomSelect(selectEl, {
        plugins: ['remove_button'],
        persist: false,
        create: false,
        maxOptions: null,
        highlight: true, // ì„ íƒì‚¬í•­
        hideSelected: false, // ì„ íƒì‚¬í•­
        render: {
        no_results: () => '<div class="no-results">ì„ íƒ ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>'
      }
      });

      // âœ… ì„ íƒê°’ ë³µì›
      tom.setValue(selectedValues.filter(v => options.includes(v)));
    }

    let rawFilterData = [];

    async function populateFilters() {
      const res = await fetch(FILTER_API);
      rawFilterData = await res.json();

      updateDependentFilters(); // ì´ˆê¸° ì „ì²´ í•„í„° í‘œì‹œ
    }

    async function loadChart() {
      showLoader();

      const channel = getSelectValues("channelFilter").join(",");
      const catB = getSelectValues("catBFilter").join(",");
      const catM = getSelectValues("catMFilter").join(",");
      const catS = getSelectValues("catSFilter").join(",");
      const brand = getSelectValues("brandFilter").join(",");
      //const products = getSelectValues("productFilter").join(",");

      if (brand.length === 0 && catS.length === 0) {
        alert("í•˜ë‚˜ ì´ìƒì˜ ë¸Œëœë“œ ë˜ëŠ” ì¹´í…Œê³ ë¦¬(ì†Œ)ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        hideLoader();
        return;
      }

      const productOptions = document.getElementById("productFilter").selectedOptions;
      const products = Array.from(productOptions).map(opt => opt.value).join(",");

      try {
        const url = `${DATA_API}?channel=${encodeURIComponent(channel)}&catB=${encodeURIComponent(catB)}&catM=${encodeURIComponent(catM)}&catS=${encodeURIComponent(catS)}&brand=${encodeURIComponent(brand)}&products=${encodeURIComponent(products)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;

        const response = await fetch(url);
        const data = await response.json();
        //drawChart(data);
        drawMultiChart(data);
      } catch (error) {
        alert("ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        console.error(error);
      } finally {
        hideLoader();
      }
    }

    async function loadChartBrand() {
      showLoader();

      const channel = getSelectValues("channelFilter").join(",");
      const catB = getSelectValues("catBFilter").join(",");
      const catM = getSelectValues("catMFilter").join(",");
      const catS = getSelectValues("catSFilter").join(",");
      const brand = getSelectValues("brandFilter").join(",");
      //const products = getSelectValues("productFilter").join(",");

      if (catS.length === 0) {
        alert("í•˜ë‚˜ ì´ìƒì˜ ì¹´í…Œê³ ë¦¬(ì†Œ)ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        hideLoader();
        return;
      }

      const productOptions = document.getElementById("productFilter").selectedOptions;
      const products = Array.from(productOptions).map(opt => opt.value).join(",");

      try {
        const url = `${DATA_BRAND_API}?channel=${encodeURIComponent(channel)}&catB=${encodeURIComponent(catB)}&catM=${encodeURIComponent(catM)}&catS=${encodeURIComponent(catS)}&brand=${encodeURIComponent(brand)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;

        const response = await fetch(url);
        const data = await response.json();
        //drawChart(data);
        drawMultiChartBrand(data);
      } catch (error) {
        alert("ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        console.error(error);
      } finally {
        hideLoader();
      }
    }

    function drawChart(data) {
      if (data.length === 0) {
        document.getElementById("chart_div").innerHTML = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const chartData = new google.visualization.DataTable();
      chartData.addColumn("string", "ë‚ ì§œ");
      const productNames = [...new Set(data.map(row => row.Product_Name))];
      productNames.forEach(name => chartData.addColumn("number", name));

      const dateMap = {};
      data.forEach(row => {
        if (!dateMap[row.date]) dateMap[row.date] = {};
        dateMap[row.date][row.Product_Name] = row.Rank;
      });

      const rows = Object.keys(dateMap).sort().map(date => {
        const row = [date];
        productNames.forEach(name => {
          row.push(dateMap[date][name] ?? null);
        });
        return row;
      });
      chartData.addRows(rows);

      const options = {
        title: "ì œí’ˆë³„ ìˆœìœ„ ì¶”ì´",
        curveType: "function",
        legend: { position: "right", textStyle: { fontSize: 12 } },
        height: 900,
        chartArea: { left: 60, top: 60, width: "75%", height: "75%" },
        vAxis: {
          title: "ìˆœìœ„",
          direction: -1,
          viewWindow: { min: 1 },
          textStyle: { fontSize: 12 },
          titleTextStyle: { fontSize: 14 },
        },
        hAxis: {
          title: "ë‚ ì§œ",
          slantedText: true,
          slantedTextAngle: 45,
          textStyle: { fontSize: 12 },
          titleTextStyle: { fontSize: 14 },
        },
      };

      const chart = new google.visualization.LineChart(document.getElementById("chart_div"));
      chart.draw(chartData, options);
    }

    function drawMultiChart(data, highlightBrand = null) {
      const container = document.getElementById("multi_chart_container");
      container.innerHTML = ""; // ê¸°ì¡´ ì°¨íŠ¸ ì´ˆê¸°í™”

      // ì œí’ˆ â†’ ë¸Œëœë“œ ë§¤í•‘
      const productToBrand = {};
      data.forEach(row => {
        productToBrand[row.Product_Name] = row.Brand_Name;
      });

      // ì œí’ˆ â†’ Link ë§¤í•‘
      const productToLink = {};
      data.forEach(row => {
        productToLink[row.Product_Name] = row.Link;
      });

      // 1. í”Œë«í¼ + ì¹´í…Œê³ ë¦¬(ì†Œ) ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
      const grouped = {};
      data.forEach(row => {
        const key = `${row.Channel} | ${row.Category_S}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(row);
      });

      // 2. ê·¸ë£¹ë³„ë¡œ ì°¨íŠ¸ ìƒì„±
      Object.entries(grouped).forEach(([groupKey, groupData], index) => {
        const chartDiv = document.createElement("div");
        chartDiv.id = `chart_${index}`;
        chartDiv.style.marginBottom = "50px";
        chartDiv.style.height = "900px";
        container.appendChild(chartDiv);

        const chartData = new google.visualization.DataTable();
        chartData.addColumn("string", "ë‚ ì§œ");

        const products = [...new Set(groupData.map(d => d.Product_Name))];
        products.forEach(p => chartData.addColumn("number", p));

        // ë‚ ì§œë³„ë¡œ ìˆœìœ„ êµ¬ì„±
        const dateMap = {};
        groupData.forEach(row => {
          if (!dateMap[row.date]) dateMap[row.date] = {};
          dateMap[row.date][row.Product_Name] = row.Rank;
        });

        const rows = Object.keys(dateMap).sort().map(date => {
          const row = [date];
          products.forEach(p => {
            row.push(dateMap[date][p] ?? null);
          });
          return row;
        });
        chartData.addRows(rows);

        // ì‹œë¦¬ì¦ˆë³„ ê°•ì¡° ì„¤ì •
        const series = {};
        products.forEach((productName, idx) => {
          const brand = productToBrand[productName];
          if (highlightBrand && brand !== highlightBrand) {
            series[idx] = { color: '#ccc', lineWidth: 1 };
          } else {
            series[idx] = { lineWidth: 3 };
          }
        });

        const options = {
          title: groupKey,
          curveType: "function",
          series: series,
          legend: { position: "right", textStyle: { fontSize: 11 } },
          height: 900,
          chartArea: { left: 60, top: 60, width: "75%", height: "75%" },
          vAxis: {
            title: "ìˆœìœ„",
            direction: -1,
            viewWindow: { min: 1 },
            textStyle: { fontSize: 11 },
            titleTextStyle: { fontSize: 14 }
          },
          hAxis: {
            title: "ë‚ ì§œ",
            slantedText: true,
            slantedTextAngle: 45,
            textStyle: { fontSize: 11 },
            titleTextStyle: { fontSize: 14 }
          }
        };

        const chart = new google.visualization.LineChart(chartDiv);
        chart.draw(chartData, options);

        // ë¸Œëœë“œ ë²„íŠ¼ì€ ì²« ì°¨íŠ¸ ë Œë” ì‹œì—ë§Œ ì¶”ê°€
        if (index === 0) {
          const allBrands = [...new Set(data.map(row => row.Brand_Name))].sort();
          renderBrandHighlightButtons(allBrands, data);
        }

        google.visualization.events.addListener(chart, 'select', function () {
          const selection = chart.getSelection();
          if (selection.length > 0) {
            const column = selection[0].column;
            if (column !== null) {
              const productIndex = column - 1;
              const productName = products[productIndex];
              const link = productToLink[productName];
              if (link) {
                window.open(link, "_blank");
              }
            }
          }
        });


      });
    }


    function drawMultiChartBrand(data) {
      const container = document.getElementById("multi_chart_container");
      container.innerHTML = ""; // ê¸°ì¡´ ì°¨íŠ¸ ì´ˆê¸°í™”

      // 1. í”Œë«í¼ + ì¹´í…Œê³ ë¦¬(ì†Œ) ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
      const grouped = {};

      data.forEach(row => {
        const key = `${row.Channel} | ${row.Category_S}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(row);
      });

      // 2. ê·¸ë£¹ë³„ë¡œ ì°¨íŠ¸ ìƒì„±
      Object.entries(grouped).forEach(([groupKey, groupData], index) => {
        const chartDiv = document.createElement("div");
        chartDiv.id = `chart_${index}`;
        chartDiv.style.marginBottom = "50px";
        chartDiv.style.height = "900px";
        container.appendChild(chartDiv);

        const chartData = new google.visualization.DataTable();
        chartData.addColumn("string", "ë‚ ì§œ");

        const brands = [...new Set(groupData.map(d => d.Brand_Name))];
        brands.forEach(p => chartData.addColumn("number", p));

        // ë‚ ì§œë³„ë¡œ ìˆœìœ„ êµ¬ì„±
        const dateMap = {};
        groupData.forEach(row => {
          if (!dateMap[row.date]) dateMap[row.date] = {};
          dateMap[row.date][row.Brand_Name] = row.Score;
        });

        const rows = Object.keys(dateMap).sort().map(date => {
          const row = [date];
          brands.forEach(p => {
            row.push(dateMap[date][p] ?? null);
          });
          return row;
        });
        chartData.addRows(rows);

        const options = {
          title: groupKey,
          curveType: "function",
          legend: { position: "right", textStyle: { fontSize: 11 } },
          height: 900,
          chartArea: { left: 60, top: 60, width: "75%", height: "75%" },
          vAxis: {
            title: "ìˆœìœ„",
            viewWindow: { min: 1 },
            textStyle: { fontSize: 11 },
            titleTextStyle: { fontSize: 14 }
          },
          hAxis: {
            title: "ë‚ ì§œ",
            slantedText: true,
            slantedTextAngle: 45,
            textStyle: { fontSize: 11 },
            titleTextStyle: { fontSize: 14 }
          }
        };

        const chart = new google.visualization.LineChart(chartDiv);
        chart.draw(chartData, options);
      });
    }


    async function loadProductsByBrand() {
      const channel = getSelectValues("channelFilter").join(",");
      const catB = getSelectValues("catBFilter").join(",");
      const catM = getSelectValues("catMFilter").join(",");
      const catS = getSelectValues("catSFilter").join(",");
      const brand = getSelectValues("brandFilter").join(",");

      if (!brand) return;

      const url = `${DATA_API}?channel=${encodeURIComponent(channel)}&catB=${encodeURIComponent(catB)}&catM=${encodeURIComponent(catM)}&catS=${encodeURIComponent(catS)}&brand=${encodeURIComponent(brand)}`;

      const response = await fetch(url);
      const data = await response.json();

      const productSet = new Set(data.map(row => row.Product_Name));
      const select = document.getElementById("productFilter");
      select.innerHTML = "";

      Array.from(productSet).sort().forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });

    }

    async function loadProductOptions() {
      showLoader();

      const channel = getSelectValues("channelFilter").join(",");
      const catB = getSelectValues("catBFilter").join(",");
      const catM = getSelectValues("catMFilter").join(",");
      const catS = getSelectValues("catSFilter").join(",");
      const brand = getSelectValues("brandFilter");

      if (brand.length === 0 && catS.length === 0) {
        alert("í•˜ë‚˜ ì´ìƒì˜ ë¸Œëœë“œ ë˜ëŠ” ì¹´í…Œê³ ë¦¬(ì†Œ)ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        hideLoader();
        return;
      }

      try {
        const brandStr = brand.join(",");
        const url = `${DATA_API}?channel=${encodeURIComponent(channel)}&catB=${encodeURIComponent(catB)}&catM=${encodeURIComponent(catM)}&catS=${encodeURIComponent(catS)}&brand=${encodeURIComponent(brandStr)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;

        console.log("ìš”ì²­ URL:", url);

        const response = await fetch(url);
        const data = await response.json();

        const productSet = new Set(data.map(row => row.Product_Name));
        const select = document.getElementById("productFilter");
        select.innerHTML = "";

        Array.from(productSet).sort().forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      } catch (error) {
        alert("ì œí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        console.error(error);
      } finally {
        hideLoader();
      }
    }

    function showLoader() {
      document.getElementById("fullscreen-loader").style.display = "flex";
    }

    function hideLoader() {
      document.getElementById("fullscreen-loader").style.display = "none";
    }

    function getSelectedValues() {
      return {
        channel: getSelectValues("channelFilter"),
        catB: getSelectValues("catBFilter"),
        catM: getSelectValues("catMFilter"),
        catS: getSelectValues("catSFilter"),
        brand: getSelectValues("brandFilter")
      };
    }

    let isUpdatingFilters = false;

    function updateDependentFilters() {
      if (isUpdatingFilters) return;
      isUpdatingFilters = true;

      const selected = getSelectedValues();

      // ê° í•„í„°ì— ëŒ€í•´, ìê¸° ìì‹ ì„ ì œì™¸í•œ í•„í„° ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§
      const getFilteredOptions = (excludeKey) => {
        return rawFilterData.filter(row => {
          return (
            (excludeKey === "channel" || !selected.channel.length || selected.channel.includes(row.Channel)) &&
            (excludeKey === "catB" || !selected.catB.length || selected.catB.includes(row.Category_B)) &&
            (excludeKey === "catM" || !selected.catM.length || selected.catM.includes(row.Category_M)) &&
            (excludeKey === "catS" || !selected.catS.length || selected.catS.includes(row.Category_S)) &&
            (excludeKey === "brand" || !selected.brand.length || selected.brand.includes(row.Brand_Name))
          );
        });
      };

      const getUniqueValues = (data, key) =>
        [...new Set(data.map(row => row[key]).filter(Boolean))].sort();

      // ê° í•„í„°ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê°’ ì¶”ì¶œ
      const channelOptions = getUniqueValues(getFilteredOptions("channel"), "Channel");
      const catBOptions = getUniqueValues(getFilteredOptions("catB"), "Category_B");
      const catMOptions = getUniqueValues(getFilteredOptions("catM"), "Category_M");
      const catSOptions = getUniqueValues(getFilteredOptions("catS"), "Category_S");
      const brandOptions = getUniqueValues(getFilteredOptions("brand"), "Brand_Name");

      // ì„ íƒëœ ê°’ ìœ ì§€í•˜ë©° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
      populateSelect("channelFilter", channelOptions, selected.channel);
      populateSelect("catBFilter", catBOptions, selected.catB);
      populateSelect("catMFilter", catMOptions, selected.catM);
      populateSelect("catSFilter", catSOptions, selected.catS);
      populateSelect("brandFilter", brandOptions, selected.brand);

      isUpdatingFilters = false;
    }


    function attachFilterChangeEvents() {
      ["channelFilter", "catBFilter", "catMFilter", "catSFilter", "brandFilter"].forEach(id => {
        document.getElementById(id).addEventListener("change", updateDependentFilters);
      });
    }

    function renderBrandHighlightButtons(brands, data) {
      const container = document.getElementById("brandHighlightButtons");
      container.innerHTML = "";

      const label = document.createElement("span");
      label.textContent = "ë¸Œëœë“œ í•˜ì´ë¼ì´íŠ¸:";
      label.style.marginRight = "10px";
      label.style.fontWeight = "500";
      container.appendChild(label);

      brands.forEach(brand => {
        const btn = document.createElement("button");
        btn.textContent = brand;
        btn.className = "custom-btn green";
        btn.onclick = () => drawMultiChart(data, brand);
        container.appendChild(btn);
      });

      const resetBtn = document.createElement("button");
      resetBtn.textContent = "ëª¨ë‘ ë³´ê¸°";
      resetBtn.className = "custom-btn blue";
      container.appendChild(resetBtn);
      resetBtn.onclick = () => drawMultiChart(data, null);
    }



    google.charts.load("current", { packages: ["corechart"] });
    google.charts.setOnLoadCallback(async () => {
      showLoader();
      await populateFilters();
      attachFilterChangeEvents();
      hideLoader();
      //document.getElementById("brandFilter").addEventListener("change", loadProductsByBrand);
    });
  </script>
</body>
</html>
